<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>人生已完成清单</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

<!-- 功能页面 -->
<div id="mainPage" class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>人生已完成清单</h3>
        <button id="addBtn" class="btn btn-success">新增项目</button>
    </div>
    <div id="itemContainer" class="d-flex flex-wrap gap-2"></div>
</div>

<!-- 模态框 -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">项目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">备注</label>
                    <textarea id="remarkInput" class="form-control" rows="3"></textarea>
                </div>
                <div id="uploadGroup" class="mb-3">
                    <label class="form-label">上传文件</label>
                    <input id="fileInput" type="file" class="form-control" />
                </div>
                <div id="previewGroup" class="mb-3" style="display:none;">
                    <label class="form-label">上传图片预览</label>
                    <img id="previewImg" src="" class="img-fluid rounded" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button id="saveBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const BASE_URL = "http://127.0.0.1:521";

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        loadItems();
    });

    // 身份校验
    function checkAuth() {
        const token = sessionStorage.getItem("userInfo");
        console.log(token);
        // 如果没有用户信息则跳转到登录页面
        if (!token) {
            window.location.href = "index.html";
        }
    }


    // ======= 加载按钮数据 =======
    async function loadItems() {
        const params = new URLSearchParams({
            id: 1
        });

        fetch(`${BASE_URL}/api/user/target/list?${params}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.code === 200) {
                const container = document.getElementById("itemContainer");
                container.innerHTML = "";

                const collection = data.collection;
                collection.forEach(item => {
                    const btn = document.createElement("button");
                    btn.className = item.isFinished ? "btn btn-success" : "btn btn-outline-secondary";
                    btn.innerText = item.target;
                    btn.onclick = () => openModal(item);

                    const wrapper = document.createElement("div");
                    wrapper.appendChild(btn);

                    const del = document.createElement("button");
                    del.className = "btn btn-danger btn-sm ms-1";
                    del.innerText = "删除";
                    del.onclick = () => deleteItem(item.id);
                    wrapper.appendChild(del);

                    container.appendChild(wrapper);
                });
            } else {
                alert(data.msg || "获取数据失败");
            }
        })
        .catch(error => {
            console.error('请求失败:', error);
            alert('网络错误');
        });
    }

    // ======= 模态框 =======
    let currentItem = null;
    const modal = new bootstrap.Modal(document.getElementById("itemModal"));

    function openModal(item) {
        currentItem = item;
        document.getElementById("remarkInput").value = item.remark || "";

        if (item.done) {
            document.getElementById("uploadGroup").style.display = "none";
            document.getElementById("previewGroup").style.display = "block";
            document.getElementById("previewImg").src = item.imgUrl;
        } else {
            document.getElementById("uploadGroup").style.display = "block";
            document.getElementById("previewGroup").style.display = "none";
        }

        modal.show();
    }

    // 保存
    document.getElementById("saveBtn").onclick = async function () {
        const remark = document.getElementById("remarkInput").value;
        const formData = new FormData();
        formData.append("id", currentItem.id);
        formData.append("remark", remark);

        const file = document.getElementById("fileInput").files[0];
        if (file) formData.append("file", file);

        await fetch("/api/saveItem", {
            method: "POST",
            headers: { Authorization: localStorage.getItem("token") },
            body: formData
        });

        modal.hide();
        loadItems();
    };

    // 新增
    document.getElementById("addBtn").onclick = async function () {
        const name = prompt("请输入按钮名称：");
        if (!name) return;
        await fetch("/api/addItem", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: localStorage.getItem("token")
            },
            body: JSON.stringify({ name })
        });
        loadItems();
    };

    // 删除
    async function deleteItem(id) {
        if (!confirm("确认删除？")) return;
        await fetch(`/api/deleteItem/${id}`, {
            method: "DELETE",
            headers: { Authorization: localStorage.getItem("token") }
        });
        loadItems();
    }

    // 校验身份
    checkAuth();
</script>
</body>
</html>
